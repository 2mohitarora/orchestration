sudo apt-get update && sudo apt-get install wget gpg coreutils
wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list

sudo apt-get update && sudo apt-get install consul=1.17.3-1

//========Common Consul Setup===============
sudo rm -f /etc/consul.d/consul.hcl /etc/consul.d/consul.env
sudo touch /etc/consul.d/consul.hcl
sudo vi /etc/consul.d/consul.hcl

# Copy consul.hcl from appropriate folder 

-------------Extra setup only for server-----------
sudo touch /etc/consul.d/server.hcl
sudo chmod 640 /etc/consul.d/server.hcl
sudo vi /etc/consul.d/server.hcl

# Copy server.hcl from appropriate folder 

---------------Jump boxes-----
Jump box setup if applicable
------------------------------

//Install Service
sudo touch /etc/systemd/system/consul.service
sudo vi /etc/systemd/system/consul.service

[Unit]
Description="HashiCorp Consul - A service mesh solution"
Documentation=https://www.consul.io/
Requires=network-online.target
After=network-online.target
ConditionFileNotEmpty=/etc/consul.d/consul.hcl

[Service]
EnvironmentFile=-/etc/consul.d/consul.env
ExecStart=/usr/bin/consul agent -config-dir=/etc/consul.d/
ExecReload=/bin/kill --signal HUP $MAINPID
KillMode=process
KillSignal=SIGTERM
Restart=on-failure
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target

//Validate
sudo consul validate /etc/consul.d/
sudo systemctl enable consul
sudo systemctl start consul
=======================
Join local consul cluster in the end 
=====================================
Federation
Step 1 - Bring up East Consul and Nomad
Step 2 - Install East Mesh gateway : nomad job run -address=http://<EAST_IP>:4646 -region=east meshgateway.hcl 
Step 3 - Get East Mesh gateway IP 
Step 4 - Bring up West Consul and Nomad (East Gateway IPs will be needed in west server config)
Step 5 - Install West mesh gateway : nomad job run -address=http://<WEST_IP>:4646 -region=west meshgateway.hcl
Step 6 - Join clusters over wan, from west server : sudo consul join -wan <IP>
Step 7 - Test : consul members -wan from both east and west consul servers
Step 8 - From servers, curl localhost:8500/v1/catalog/services?dc=<>
Step 9 - sudo nomad server join <IP>:4648
